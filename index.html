<html>
    <head>
        <title>Show NFTs from OpenSea</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    </head>
    <body>
        <div id="root"></div>
        <script>
            let account = null;

            const connect = async () => {
                if (typeof window.ethereum !== 'undefined') {
                    console.log('Metamask detected. Connecting...');
                    try {
                        await window.ethereum.request({ method: 'eth_requestAccounts' });
                        window.web3 = new Web3(window.ethereum);

                        const currentChainId = await web3.eth.getChainId();

                        // Ensure we're on Sepolia network
                        if (currentChainId !== 0xaa36a7) {
                            console.log('Switching to Sepolia network...');
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: '0xaa36a7' }], // Sepolia chain ID
                                });
                            } catch (error) {
                                console.error('Error switching to Sepolia network:', error);
                                alert('Please switch your wallet to the Sepolia network.');
                                return false;
                            }
                        }

                        const accounts = await web3.eth.getAccounts();
                        account = accounts[0];
                        console.log('Connected wallet address:', account);
                        return true;
                    } catch (error) {
                        console.error('Error connecting to Metamask:', error);
                        alert('Connection failed. Please try again.');
                        return false;
                    }
                } else {
                    alert('Metamask not detected. Please install Metamask.');
                    console.error('Metamask not detected.');
                    return false;
                }
            };

            const fetchNFTs = async () => {
                const isConnected = await connect();
                if (!isConnected) return;

                const rootElement = document.getElementById('root');
                rootElement.innerHTML = `<p>Loading NFTs...</p>`;

                try {
                    // Use the correct API endpoint
                    const apiEndpoint = `https://testnets-api.opensea.io/api/v2/chain/sepolia/account/${account}/nfts`;
                    const response = await fetch(apiEndpoint);

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();

                    if (data && data.nfts && data.nfts.length > 0) {
                        rootElement.innerHTML = data.nfts.map(createNFTElement).join('');
                    } else {
                        rootElement.innerHTML = `<p>No NFTs found for this wallet.</p>`;
                    }
                } catch (error) {
                    console.error('Error fetching NFTs:', error);
                    rootElement.innerHTML = `<p>Error loading NFTs. Please try again later.</p>`;
                }
            };

            const createNFTElement = (nft) => {
                // Destructure and fallback for missing fields
                const {
                    identifier,
                    name = 'Unnamed NFT',
                    description = 'No description available.',
                    image_url,
                    display_image_url,
                    opensea_url,
                } = nft;

                // Determine which image URL to use
                const image = display_image_url || image_url || 'fallback-image-url.jpg';

                console.log('NFT Metadata:', nft); // Debugging: Log NFT data

                return `
                    <div>
                        <h1>#${identifier} ${name}</h1>
                        <img src="${image}" alt="NFT image" width="200" height="200" onerror="this.src='fallback-image-url.jpg';"/>
                        <p>${description}</p>
                        <a href="${opensea_url}" target="_blank">View on OpenSea</a>
                        <hr />
                    </div>`;
            };

            fetchNFTs();
        </script>
    </body>
</html>
